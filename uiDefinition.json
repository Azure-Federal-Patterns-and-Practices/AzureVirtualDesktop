{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "Azure Virtual Desktop",
            "steps": [
                {
                    "name": "basics",
                    "label": "Basics",
                    "elements": [
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope",
                            "location": {
                                "resourceTypes": [
                                    "Microsoft.Automation/automationAccounts",
                                    "Microsoft.Insights/diagnosticsettings"
                                ]
                            }
                        },
                        {
                            "name": "servicePrincipalApi",
                            "type": "Microsoft.Solutions.GraphApiControl",
                            "request": {
                                "method": "GET",
                                "path": "/v1.0/serviceprincipals?$filter=appId eq '9cdead84-a844-4324-93f2-b2e6bb768d07'"
                            }
                        },
                        {
                            "name": "identifier",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Identifier",
                            "toolTip": "Provide a identifier (max 3 characters) for the resource groups and resources created as part of the solution.",
                            "placeholder": "Example: app1",
                            "constraints": {
                                "required": true,
                                "regex": "^[a-z0-9A-Z-]{1,3}$",
                                "validationMessage": "The identifier must be 1-3 characters."
                            }
                        },
                        {
                            "name": "environment",
                            "type": "Microsoft.Common.DropDown",
                            "visible": true,
                            "label": "Environment",
                            "defaultValue": "Development",
                            "toolTip": "Select the target environment for the solution: Development (d), Test (t), Production (p). The abbreviation will be used as part of the naming convention for the resoure groups and resources.",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Development (d)",
                                        "value": "d"
                                    },
                                    {
                                        "label": "Production (p)",
                                        "value": "p"
                                    },
                                    {
                                        "label": "Test (t)",
                                        "value": "t"
                                    }
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "hostPool",
                    "label": "Host Pool",
                    "visible": true,
                    "elements": [
                        {
                            "name": "type",
                            "type": "Microsoft.Common.DropDown",
                            "visible": true,
                            "label": "Type",
                            "defaultValue": "Pooled",
                            "multiLine": true,
                            "toolTip": "",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Pooled",
                                        "description": "",
                                        "value": "Pooled"
                                    },
                                    {
                                        "label": "Personal",
                                        "description": "",
                                        "value": "Personal"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "loadBalancerType",
                            "type": "Microsoft.Common.DropDown",
                            "visible": "[equals(steps('managementPlane').managementPlaneHostPoolSettings.hostPoolType, 'Pooled')]",
                            "label": "Load Balancing Algorithm",
                            "defaultValue": "BreadthFirst",
                            "multiLine": true,
                            "toolTip": "Breadth-first load balancing distributes new user sessions across all available session hosts in the host pool. Depth-first load balancing distributes new user sessions to an available session host with the highest number of connections but has not reached its maximum session limit threshold.",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "BreadthFirst",
                                        "description": "Each new user is placed on the next VM. (Performance Optimized)",
                                        "value": "BreadthFirst"
                                    },
                                    {
                                        "label": "DepthFirst",
                                        "description": "Each new user is placed on the same VM until max sessions limit. (Cost Optimized)",
                                        "value": "DepthFirst"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "maxSessions",
                            "type": "Microsoft.Common.TextBox",
                            "visible": "[equals(steps('managementPlane').managementPlaneHostPoolSettings.hostPoolType, 'Pooled')]",
                            "label": "Max Session Limit",
                            "defaultValue": "8",
                            "toolTip": "The maximum number of users that have concurrent sessions on a session host. When setting a host pool to have depth first load balancing or planning to use Autoscaling, you must set an appropriate max session limit according to the configuration of your deployment and capacity of your VMs.",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": ""
                            }
                        },
                        {
                            "name": "assignmentType",
                            "type": "Microsoft.Common.DropDown",
                            "visible": "[equals(steps('managementPlane').managementPlaneHostPoolSettings.hostPoolType, 'Personal')]",
                            "label": "Assignment Type",
                            "defaultValue": "Automatic (Recommended)",
                            "multiLine": true,
                            "toolTip": "Automatic assignment - The service will select an available host and assign it to an user. Direct assignment â€“ Admin selects a specific host to assign to an user.",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Automatic (Recommended)",
                                        "description": "Users are assigned an available VM the first time they connect.",
                                        "value": "Automatic"
                                    },
                                    {
                                        "label": "Direct",
                                        "description": "An administrator assigns a VM for each individual user.",
                                        "value": "Direct"
                                    }
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "virtualMachines",
                    "label": "Virtual Machines",
                    "visible": true,
                    "elements": [
                        {
                            "name": "size",
                            "type": "Microsoft.Compute.SizeSelector",
                            "label": "Virtual Machine Size",
                            "toolTip": "Select the size of the virtual machines. Multi-session hosts should have 4 - 24 vCPUs. Single session host should have 2 or more vCPUs.",
                            "recommendedSizes": [],
                            "imageReference": {
                                "publisher": "MicrosoftWindowsServer",
                                "offer": "WindowsServer",
                                "sku": "2019-Datacenter"
                            },
                            "osPlatform": "Windows",
                            "visible": true,
                            "scope": {
                                "subscriptionId": "[steps('basics').resourceScope.subscription.subscriptionId]",
                                "location": "[steps('basics').resourceScope.location.name]"
                            }
                        },
                        {
                            "name": "count",
                            "type": "Microsoft.Common.Slider",
                            "label": "Count",
                            "defaultValue": 2,
                            "toolTip": "Select the number of virtual machines needed to expedite your data migration.",
                            "min": 1,
                            "max": 4999,
                            "showStepMarkers": true,
                            "constraints": {
                                "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "diskSku",
                            "type": "Microsoft.Common.DropDown",
                            "label": "OS Disk SKU",
                            "filter": true,
                            "defaultValue": "Premium",
                            "toolTip": "Select session host disk type to host the OS.",
                            "constraints": {
                                "required": true,
                                "allowedValues": [
                                    {
                                        "label": "Standard",
                                        "value": "Standard_LRS"
                                    },
                                    {
                                        "label": "Premium",
                                        "value": "Premium_LRS"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "diskZeroTrust",
                            "type": "Microsoft.Common.CheckBox",
                            "label": "Zero trust disk configuration",
                            "defaultValue": false,
                            "toolTip": "Enables disk encryption and Zero trust settings on management VM and session hosts disks"
                        },
                        {
                            "name": "image",
                            "type": "Microsoft.Common.Section",
                            "visible": "[equals(steps('sessionHosts').deploySessionHosts, true)]",
                            "label": "Image",
                            "elements": [
                                {
                                    "name": "source",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Image Source",
                                    "filter": true,
                                    "defaultValue": "Marketplace",
                                    "toolTip": "Select the type of image to deploy on the session hosts.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Marketplace",
                                                "value": false
                                            },
                                            {
                                                "label": "Compute Gallery",
                                                "value": true
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "marketplaceImage",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": "[equals(steps('sessionHosts').sessionHostsOsSection.sessionHostsImageSource, false)]",
                                    "label": "OS version",
                                    "filter": true,
                                    "defaultValue": "Windows 11 22H2 (Gen2)",
                                    "toolTip": "Select the operating system version of the session hosts.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Windows 10 21H2",
                                                "value": "win10_21h2"
                                            },
                                            {
                                                "label": "Windows 10 21H2 - Office 365",
                                                "value": "win10_21h2_office"
                                            },
                                            {
                                                "label": "Windows 10 22H2 (Gen2)",
                                                "value": "win10_22h2_g2"
                                            },
                                            {
                                                "label": "Windows 10 22H2 - Office 365 (Gen2)",
                                                "value": "win10_22h2_office_g2"
                                            },
                                            {
                                                "label": "Windows 11",
                                                "value": "win11_21h2"
                                            },
                                            {
                                                "label": "Windows 11 - Office 365",
                                                "value": "win11_21h2_office"
                                            },
                                            {
                                                "label": "Windows 11 22H2 (Gen2)",
                                                "value": "win11_22h2"
                                            },
                                            {
                                                "label": "Windows 11 22H2 - Office 365 (Gen2)",
                                                "value": "win11_22h2_office"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "galleryImage",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "visible": "[equals(steps('sessionHosts').sessionHostsOsSection.sessionHostsImageSource, true)]",
                                    "label": "Image",
                                    "resourceType": "Microsoft.Compute/galleries/images",
                                    "constraints": {
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
                            "name": "localAdminCredentials",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "label": "Local Administrator Credential",
                            "elements": [
                                {
                                    "name": "username",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Username",
                                    "defaultValue": "",
                                    "placeholder": "Example: xadmin",
                                    "toolTip": "Enter the username for the local administrator account.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "",
                                        "validationMessage": ""
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "password",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "label": {
                                        "password": "Password",
                                        "confirmPassword": "Confirm Password"
                                    },
                                    "toolTip": "The password must be alphanumeric, contain at least 12 characters, have at least 1 letter, 1 number and 1 special character.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=_!*<>()])(?=\\S+$).{12,123}$",
                                        "validationMessage": "The value must be within 12 to 123 characters, be alphanumeric, and include 1 lower case character, 1 upper case character, 1 number, and 1 special character that is not '\\' or '-'."
                                    },
                                    "options": {
                                        "hideConfirmation": false
                                    },
                                    "visible": true
                                }
                            ]
                        },
                        {
                            "name": "security",
                            "type": "Microsoft.Common.Section",
                            "label": "Security",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "type",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Type",
                                    "filter": true,
                                    "defaultValue": "Trusted Launch",
                                    "toolTip": "Choose a type of security that matches your needs: Standard includes basic protections at no additional cost. Trusted launch virtual machines provide additional security features on Gen2 virtual machines to protect against persistent and advanced attacks.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Confidential Virtual Machines",
                                                "value": "ConfidentialVM"
                                            },
                                            {
                                                "label": "Standard",
                                                "value": "Standard"
                                            },
                                            {
                                                "label": "Trusted Launch",
                                                "value": "TrustedLaunch"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "secureBoot",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "visible": "[or(equals(steps('sessionHosts').sessionHostsSecuritySection.securityType, 'TrustedLaunch'), equals(steps('sessionHosts').sessionHostsSecuritySection.securityType, 'ConfidentialVM'))]",
                                    "label": "Enable secure boot",
                                    "defaultValue": "Yes",
                                    "toolTip": "Secure boot helps protect your VMs against boot kits, rootkits, and kernel-level malware.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Yes",
                                                "value": true
                                            },
                                            {
                                                "label": "No",
                                                "value": false
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "vTpm",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "visible": "[or(equals(steps('sessionHosts').sessionHostsSecuritySection.securityType, 'TrustedLaunch'), equals(steps('sessionHosts').sessionHostsSecuritySection.securityType, 'ConfidentialVM'))]",
                                    "label": "Enable vTPM",
                                    "defaultValue": "Yes",
                                    "toolTip": "Virtual Trusted Platform Module (vTPM) is TPM2.0 compliant and validates your VM boot integrity apart from securely storing keys and secrets.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Yes",
                                                "value": true
                                            },
                                            {
                                                "label": "No",
                                                "value": false
                                            }
                                        ]
                                    }
                                }
                            ]
                        },
                        {
                            "name": "network",
                            "type": "Microsoft.Common.Section",
                            "label": "Network",
                            "visible": true,
                            "elements": []
                        },
                        {
                            "name": "identity",
                            "type": "Microsoft.Common.Section",
                            "label": "Identity",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "solution",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "visible": true,
                                    "label": "Active Directory Solution",
                                    "defaultValue": "Active Directory Domain Services (AD DS)",
                                    "toolTip": "Choose the Active Directory solution that already exists.",
                                    "constraints": {
                                        "required": true,
                                        "allowedValues": [
                                            {
                                                "label": "Active Directory Domain Services (ADDS)",
                                                "value": "ActiveDirectoryDomainServices"
                                            },
                                            {
                                                "label": "Azure Active Directory (AAD)",
                                                "value": "AzureActiveDirectory"
                                            },
                                            {
                                                "label": "Azure Active Directory Domain Services (AADDS)",
                                                "value": "AzureActiveDirectoryDomainServices"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "domainName",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[not(equals(steps('virtualMachines').identity.solution, 'AzureActiveDirectory'))]",
                                    "label": "Domain Name",
                                    "toolTip": "Provide domain name for the selected Active Directory solution.",
                                    "placeholder": "Example: contoso.com",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "intune",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "visible": "[equals(steps('virtualMachines').identity.solution, 'AzureActiveDirectory')]",
                                    "label": "Intune Enrollment",
                                    "defaultValue": "No",
                                    "toolTip": "If Intune is configured in your Azure AD tenant, you can choose to have the VM automatically enrolled during the deployment by selecting Yes.",
                                    "constraints": {
                                        "required": false,
                                        "allowedValues": [
                                            {
                                                "label": "Yes",
                                                "value": true
                                            },
                                            {
                                                "label": "No",
                                                "value": false
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "ouPath",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[not(equals(steps('identity').identityDomainInformation.identityServiceProvider, 'AAD'))]",
                                    "label": "OU Path",
                                    "toolTip": "Input the distinguished name for the desired organization unit for session hosts. If a value is not provided, the session hosts will be placed in the default organizational unit.",
                                    "placeholder": "Example: OU=session-hosts,OU=avd,DC=contoso,DC=com",
                                    "constraints": {}
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "userProfiles",
                    "label": "User Profiles",
                    "visible": true,
                    "elements": []
                },
                {
                    "name": "scaling",
                    "label": "Scaling",
                    "visible": true,
                    "elements": [
                        {
                            "name": "beginPeakTime",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Begin Peak Time",
                            "defaultValue": "8:00",
                            "placeholder": "",
                            "toolTip": "Input the time when peak hours begin for your end users.",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^[012]?[0-9]:[0-5][0-9]$",
                                        "message": "The value must be in a proper time format with a two digit hour and two digit minutes, e.g. 12am should be input as 00:00."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "endPeakTime",
                            "type": "Microsoft.Common.TextBox",
                            "label": "End Peak Time",
                            "defaultValue": "17:00",
                            "placeholder": "",
                            "toolTip": "Input the time when peak hours end for your end users.",
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^[012]?[0-9]:[0-5][0-9]$",
                                        "message": "The value must be in a proper time format with a two digit hour and two digit minutes, e.g. 8pm should be input as 20:00."
                                    }
                                ]
                            }
                        },
                        {
                            "name": "forceLogOff",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Force Log Off (Seconds)",
                            "defaultValue": "0",
                            "toolTip": "Use this setting to force logoff users if session time limit settings cannot be used.",
                            "placeholder": "",
                            "multiLine": false,
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^[0-9]{1,3}$",
                                        "message": "The value must be between 1 and 3 digits."
                                    }
                                ]
                            },
                            "visible": true
                        },
                        {
                            "name": "minimumHosts",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Minimum Number of Session Hosts",
                            "defaultValue": "0",
                            "toolTip": "Use this setting to determine the minimum number of sessions hosts to keep online.",
                            "placeholder": "",
                            "multiLine": false,
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^[0-9]{1,4}$",
                                        "message": "The value must be between 1 and 4 digits."
                                    }
                                ]
                            },
                            "visible": true
                        },
                        {
                            "name": "cpuThreshold",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Session Threshold Per CPU",
                            "defaultValue": "1",
                            "toolTip": "Use this setting to determine the number of sessions per CPU before turning on another host.",
                            "placeholder": "",
                            "multiLine": false,
                            "constraints": {
                                "required": true,
                                "validations": [
                                    {
                                        "regex": "^[0-9]{0,1}(?:\\.[0-9]{0,2})?$",
                                        "message": "The value must be a number with 1 whole number and, if desired, a single or two digit decimal number."
                                    }
                                ]
                            },
                            "visible": true
                        }
                    ]
                },
                {
                    "name": "monitoring",
                    "label": "Monitoring",
                    "visible": true,
                    "elements": []
                },
                {
                    "name": "tags",
                    "label": "Tags",
                    "visible": true,
                    "elements": []
                }
            ]
        },
        "outputs": {
            "parameters": {
                "ActiveDirectorySolution": "",
                "Availability": "",
                "AvdObjectId": "[first(map(steps('basics').servicePrincipalApi.value, (item) => item.id))]",
                "AzureFilesPrivateDnsZoneResourceId": "",
                "CustomRdpProperty": "",
                "DiskEncryption": "",
                "DiskSku": "",
                "DomainJoinPassword": "",
                "DomainJoinUserPrincipalName": "",
                "DomainName": "",
                "DrainMode": "",
                "Environment": "[steps('basics').environment]",
                "FslogixShareSizeInGB": "",
                "FslogixSolution": "",
                "FslogixStorage": "",
                "HostPoolType": "",
                "Identifier": "[steps('basics').identifier]",
                "ImageOffer": "",
                "ImagePublisher": "",
                "ImageSku": "",
                "ImageVersion": "",
                "KerberosEncryption": "",
                "Location": "",
                "LogAnalyticsWorkspaceRetention": "",
                "LogAnalyticsWorkspaceSku": "",
                "MaxSessionLimit": "",
                "Monitoring": "",
                "OuPath": "",
                "RecoveryServices": "",
                "ScalingBeginPeakTime": "",
                "ScalingEndPeakTime": "",
                "ScalingLimitSecondsToForceLogOffUser": "",
                "ScalingMinimumNumberOfRdsh": "",
                "ScalingSessionThresholdPerCPU": "",
                "ScalingTool": "",
                "ScreenCaptureProtection": "",
                "SecurityPrincipalObjectIds": "",
                "SecurityPrincipalNames": "",
                "SentinelLogAnalyticsWorkspaceName": "",
                "SentinelLogAnalyticsWorkspaceResourceGroupName": "",
                "SentinelLogAnalyticsWorkspaceSubscriptionId": "",
                "SessionHostCount": "",
                "SessionHostIndex": "",
                "StampIndex": "",
                "StorageCount": "",
                "StorageIndex": "",
                "SubnetName": "",
                "Tags": "",
                "ValidationEnvironment": "",
                "VirtualNetworkName": "",
                "VirtualNetworkResourceGroupName": "",
                "VmPassword": "",
                "VmSize": "",
                "VmUsername": ""
            },
            "kind": "Subscription",
            "location": "[steps('basics').resourceScope.location.name]",
            "subscriptionId": "[steps('basics').resourceScope.subscription.id]"
        }
    }
}